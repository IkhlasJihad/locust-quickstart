name: Load Test with Locust
#  python -m locust -f practice.py -users 3 --spawn-rate 2
on:
  workflow_dispatch:
    inputs:
      users:
        description: 'Number of concurrent users'
        required: true
        default: '30'
      spawn_rate:
        description: 'Spawn rate (users per second)'
        required: true
        default: '3'
      run_time:
        description: 'Test duration (e.g., 5m, 10m)'
        required: true
        default: '5m'

jobs:
  load-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install requirements
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Locust Load Test
      env:
        API_HOST: 'https://automationexercise.com' 
      run: |
        locust -f practice.py \
          --headless \
          --users ${{ github.event.inputs.users || '30' }} \
          --spawn-rate ${{ github.event.inputs.spawn_rate || '3' }} \
          --run-time ${{ github.event.inputs.run_time || '5m' }} \
          --host $API_HOST \
          --html report.html \
          --csv results \
          --only-summary
    
    - name: Print Test Summary to Console
      if: always()
      run: |
        echo "======================================"
        echo "üìä LOAD TEST SUMMARY"
        echo "======================================"
        echo ""
        if [ -f results_stats.csv ]; then
          echo "Test Configuration:"
          echo "  Users: ${{ github.event.inputs.users || '30' }}"
          echo "  Spawn Rate: ${{ github.event.inputs.spawn_rate || '3' }} users/sec"
          echo "  Duration: ${{ github.event.inputs.run_time || '5m' }}"
          echo ""
          echo "Results:"
          echo "----"
          tail -n +2 results_stats.csv | while IFS=',' read -r type name req_count fail_count median avg min max content_size rps fail_rate rest; do
            if [ "$name" = "Aggregated" ]; then
              echo "AGGREGATED RESULTS:"
              echo "  Total Requests: $req_count"
              echo "  Failed Requests: $fail_count"
              echo "  Failure Rate: $fail_rate"
              echo "  Requests/sec: $rps"
              echo "  Median Response Time: ${median}ms"
              echo "  Average Response Time: ${avg}ms"
              echo "  Min/Max: ${min}ms / ${max}ms"
            elif [ ! -z "$name" ]; then
              echo ""
              echo "ENDPOINT: $name"
              echo "  Requests: $req_count"
              echo "  Failures: $fail_count"
              echo "  Median: ${median}ms"
              echo "  Average: ${avg}ms"
              echo "  P95: (see CSV for details)"
            fi
          done
          echo ""
          echo "======================================"
        else
          echo "‚ùå No test results found!"
        fi

    - name: Check for HTTP Errors (4xx/5xx)
      if: always()
      run: |
        echo ""
        echo "======================================"
        echo "‚ö†Ô∏è  HTTP ERROR REPORT"
        echo "======================================"
        echo ""
        if [ -f results_failures.csv ]; then
          # Count total lines (excluding header)
          error_count=$(tail -n +2 results_failures.csv | wc -l)
          
          if [ "$error_count" -gt 0 ]; then
            echo "‚ùå Found $error_count error(s):"
            echo ""
            echo "Errors breakdown:"
            tail -n +2 results_failures.csv | while IFS=',' read -r method name error occurrences; do
              # Trim whitespace
              error=$(echo "$error" | xargs)
              occurrences=$(echo "$occurrences" | xargs)
              
              if [ ! -z "$error" ] && [ "$error" != "Error" ]; then
                # Check if it's a 4xx or 5xx error
                if echo "$error" | grep -qE "[45][0-9]{2}"; then
                  echo "  ‚ùå $name"
                  echo "     Error: $error"
                  echo "     Occurrences: $occurrences"
                  echo ""
                fi
              fi
            done
            
            # Show unique error types
            echo "Summary of error types:"
            tail -n +2 results_failures.csv | cut -d',' -f3 | sort | uniq -c | while read count error; do
              error=$(echo "$error" | xargs)
              if [ ! -z "$error" ] && [ "$error" != "Error" ]; then
                echo "  - $error: $count occurrence(s)"
              fi
            done
          else
            echo "‚úÖ No HTTP errors found! All requests were successful."
          fi
        else
          echo "‚ö†Ô∏è  results_failures.csv not found"
        fi
        echo "======================================"
        echo ""
    
    - name: Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: load-test-results
        path: |
          report.html
          results_stats.csv
          results_stats_history.csv
          results_failures.csv